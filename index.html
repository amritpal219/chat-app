<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Mixer | Local Chat Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght=400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-primary { @apply bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-700 transition duration-150 shadow-md disabled:opacity-50 disabled:cursor-not-allowed; }
        .btn-secondary { @apply bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-xl hover:bg-gray-300 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed; }
        .option-card { @apply p-4 border border-gray-200 rounded-lg cursor-pointer transition duration-200 hover:shadow-lg hover:border-indigo-500; }
        .selected-option { @apply border-indigo-600 ring-2 ring-indigo-300 bg-indigo-50; }
        #chat-area { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div id="app-container" class="w-full max-w-2xl">

        <!-- Screen 1: Landing/Entry -->
        <div id="landing-screen" class="card p-8 text-center">
            <h1 class="text-3xl font-bold mb-6 text-gray-800">Room Mixer (Local Simulation)</h1>
            <p class="text-sm text-gray-500 mb-6">Enter your name â†’ Choose an option â†’ Create/Join a room.</p>

            <div class="space-y-4">
                <input type="text" id="user-name" placeholder="Enter your name" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500" maxlength="20">

                <!-- Room Code Generation/Joining -->
                <div id="code-section" class="flex flex-col gap-3">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="generate-code-btn" class="btn-primary w-full sm:w-1/2" disabled>Generate Code & Create</button>
                        <button id="random-join-btn" class="btn-secondary w-full sm:w-1/2" disabled>Random Join / Create</button>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="target-code" placeholder="Enter Code" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 uppercase" maxlength="6">
                        <button id="enter-code-btn" class="btn-primary flex-shrink-0 px-4" disabled>Join Room</button>
                    </div>
                </div>

                <!-- Code Display -->
                <div id="code-display" class="hidden bg-indigo-50 p-4 rounded-xl text-indigo-700 font-mono text-lg transition duration-300">
                    Your Room Code: <span id="current-code" class="font-bold"></span>
                </div>
            </div>
            
            <p id="loading-message" class="text-indigo-500 mt-4 text-sm font-medium flex items-center justify-center">
                App initialized (Local Mode).
            </p>
            <p id="error-message" class="text-red-500 mt-4 text-sm font-medium"></p>
        </div>

        <!-- Screen 2: Options Modal -->
        <div id="options-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="card p-8 w-full max-w-lg">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">Choose one of these 2 options</h2>

                <div id="option-cards" class="grid grid-cols-2 gap-4 mb-6">
                    <!-- Options rendered by JS -->
                </div>

                <div class="flex justify-end gap-4">
                    <button id="cancel-options-btn" class="btn-secondary">Cancel</button>
                    <button id="confirm-options-btn" class="btn-primary" disabled>Confirm & Proceed</button>
                </div>
            </div>
        </div>

        <!-- Screen 3: Room Screen -->
        <div id="room-screen" class="hidden card p-6">
            <div class="flex justify-between items-center border-b pb-4 mb-4">
                <h2 class="text-xl font-bold text-indigo-600">Room: <span id="room-header-code"></span></h2>
                <div class="flex items-center space-x-2 text-sm text-gray-500">
                    <span id="room-header-option" class="font-medium px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full"></span>
                    <span id="room-participant-count" class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        <span id="p-count">1</span>
                    </span>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- Chat Area -->
                <div class="lg:col-span-2">
                    <div id="chat-area" class="bg-gray-50 p-3 rounded-xl border mb-3 min-h-[250px] flex flex-col justify-end space-y-2">
                        <!-- Messages displayed here -->
                        <div class="text-center text-sm text-gray-400 p-2">You joined room <span id="chat-joined-code" class="font-mono font-semibold"></span> â€” Start chatting!</div>
                    </div>

                    <div class="flex space-x-2">
                        <input type="text" id="chat-input" placeholder="Type your message..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500" autofocus>
                        <button id="send-chat-btn" class="btn-primary flex-shrink-0 px-4">Send</button>
                    </div>

                    <p class="text-xs text-gray-500 mt-2">
                        This is a local simulation. Chat history is only saved in your browser's memory.
                    </p>
                </div>

                <!-- Participants & Controls Sidebar -->
                <div class="lg:col-span-1 space-y-4">
                    <!-- Participant List -->
                    <div class="bg-white p-3 rounded-xl border">
                        <h3 class="font-semibold mb-2">Participants (<span id="p-count-sidebar">1</span>)</h3>
                        <ul id="participant-list" class="space-y-1 text-sm">
                            <!-- Participants displayed here -->
                        </ul>
                    </div>

                    <!-- Room Controls -->
                    <div class="space-y-2">
                        <button id="copy-code-btn" class="btn-secondary w-full">Copy Room Code</button>
                        <button id="leave-room-btn" class="bg-red-500 text-white font-semibold py-3 px-6 rounded-xl hover:bg-red-600 transition duration-150 w-full">Leave Room</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Pure JavaScript Logic (Purely Local Logic) -->
    <script>
        // Global Local Data Store (This is our simulated database)
        let localRooms = {}; 
        
        // Global State Variables
        let userId = null;
        let userName = '';
        let currentRoomCode = null;
        let selectedOption = null;
        let joinType = 'create';
        
        // UI Elements
        const ui = {
            landingScreen: document.getElementById('landing-screen'),
            optionsModal: document.getElementById('options-modal'),
            roomScreen: document.getElementById('room-screen'),
            userNameInput: document.getElementById('user-name'),
            targetCodeInput: document.getElementById('target-code'),
            currentCodeSpan: document.getElementById('current-code'),
            codeDisplay: document.getElementById('code-display'),
            errorMsg: document.getElementById('error-message'),
            loadingMsg: document.getElementById('loading-message'), 
            optionsCards: document.getElementById('option-cards'),
            confirmOptionsBtn: document.getElementById('confirm-options-btn'),
            roomHeaderCode: document.getElementById('room-header-code'),
            roomHeaderOption: document.getElementById('room-header-option'),
            pCount: document.getElementById('p-count'),
            pCountSidebar: document.getElementById('p-count-sidebar'),
            chatJoinedCode: document.getElementById('chat-joined-code'),
            chatArea: document.getElementById('chat-area'),
            chatInput: document.getElementById('chat-input'),
            sendChatBtn: document.getElementById('send-chat-btn'),
            participantList: document.getElementById('participant-list'),
            copyCodeBtn: document.getElementById('copy-code-btn'),
            leaveRoomBtn: document.getElementById('leave-room-btn'),
            generateCodeBtn: document.getElementById('generate-code-btn'),
            enterCodeBtn: document.getElementById('enter-code-btn'),
            randomJoinBtn: document.getElementById('random-join-btn'),
        };

        // Room Options
        const ROOM_OPTIONS = [
            { id: 1, name: "Public Chat Room", icon: "ðŸ’¬", description: "Open chat room, anyone can join with the code." },
            { id: 2, name: "Private Chat Room", icon: "ðŸ”’", description: "Secret room, host's permission required (simulation only)." },
        ];

        // --- Core Helpers ---

        function showScreen(screenId) {
            ui.landingScreen.classList.add('hidden');
            ui.optionsModal.classList.add('hidden');
            ui.roomScreen.classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');

            // Handle modal visibility
            if (screenId !== 'options-modal') {
                ui.optionsModal.classList.remove('fixed', 'flex');
            } else {
                ui.optionsModal.classList.add('fixed', 'flex');
            }
        }

        function displayError(message) {
            ui.errorMsg.textContent = message;
            setTimeout(() => ui.errorMsg.textContent = '', 5000);
        }

        // Generate a 6-character random code
        function getRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function validateUserAndCode(isCodeRequired = false) {
            userName = ui.userNameInput.value.trim();
            if (!userName) {
                displayError("Please enter your name.");
                return false;
            }
            if (isCodeRequired && ui.targetCodeInput.value.trim().length !== 6) {
                displayError("Please enter a 6-character room code.");
                return false;
            }
            return true;
        }

        function enableAppButtons() {
            ui.loadingMsg.classList.add('hidden');
            ui.generateCodeBtn.disabled = false;
            ui.randomJoinBtn.disabled = false;
            ui.userNameInput.disabled = false;
            ui.targetCodeInput.disabled = false;
            // The enter button remains disabled until both name and code are valid
            ui.enterCodeBtn.disabled = true; 
            console.log("Application buttons enabled.");
        }

        // --- Initialization ---

        function initializeApp() {
            // userId is a random value (since there is no real authentication)
            userId = crypto.randomUUID();
            renderOptions();
            enableAppButtons();
        }

        // --- Options UI/Logic ---

        function renderOptions() {
            ui.optionsCards.innerHTML = ROOM_OPTIONS.map(opt => `
                <div class="option-card flex flex-col items-center text-center p-4" data-id="${opt.id}" data-name="${opt.name}">
                    <span class="text-3xl mb-2">${opt.icon}</span>
                    <h4 class="font-semibold text-gray-800">${opt.name}</h4>
                    <p class="text-xs text-gray-500 mt-1">${opt.description}</p>
                </div>
            `).join('');

            document.querySelectorAll('.option-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected-option'));
                    card.classList.add('selected-option');
                    selectedOption = ROOM_OPTIONS.find(o => o.id === parseInt(card.dataset.id));
                    ui.confirmOptionsBtn.disabled = false;
                });
            });
        }

        function openOptions(type, code = null) {
            joinType = type;
            currentRoomCode = code;
            ui.confirmOptionsBtn.disabled = true;
            selectedOption = null;
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected-option'));

            const actionText = (type === 'create') ? 'Create' : 'Join'; 
            ui.confirmOptionsBtn.textContent = `Confirm & ${actionText}`;

            showScreen('options-modal');
        }

        // --- Room Management (Local Data Store) ---

        function createRoom(code, option) {
            if (localRooms[code]) {
                displayError("This code already exists. Try again.");
                return false;
            }

            localRooms[code] = {
                code: code,
                optionType: option.name,
                hostId: userId,
                createdAt: Date.now(),
                participants: {
                    [userId]: { name: userName, joinedAt: Date.now(), isHost: true }
                },
                chatHistory: [],
                status: 'active'
            };

            console.log("Room created (in Local Store):", code);
            joinRoom(code);
            return true;
        }

        function joinRoom(code) {
            const room = localRooms[code];
            if (!room) {
                displayError("Room code not found or room is closed.");
                showScreen('landing-screen');
                return;
            }

            currentRoomCode = code;
            ui.chatJoinedCode.textContent = code;

            const participants = room.participants;

            if (participants[userId]) {
                console.log("User is already in the room.");
                // Update name just in case
                participants[userId].name = userName;
            } else {
                // Add new participant
                if (Object.keys(participants).length >= 8) {
                    displayError("Room is full (max 8 participants).");
                    currentRoomCode = null;
                    showScreen('landing-screen');
                    return;
                }

                participants[userId] = {
                    name: userName,
                    joinedAt: Date.now(),
                    isHost: (room.hostId === userId)
                };

                // Add system message
                room.chatHistory.push({
                    senderId: 'SYSTEM',
                    name: 'System',
                    message: `${userName} has joined the room.`,
                    timestamp: Date.now()
                });
            }

            // Update UI
            updateRoomUI(room);
            showScreen('room-screen');
            ui.roomHeaderCode.textContent = currentRoomCode;
        }

        function randomJoinRoom() {
            if (!validateUserAndCode()) return;

            // Find any active room with available slots
            const availableRooms = Object.values(localRooms).filter(room => 
                Object.keys(room.participants).length < 8 && room.status === 'active'
            );

            if (availableRooms.length > 0) {
                // Random Join: Pick the first available room
                const roomToJoin = availableRooms[0];
                displayError(`Joining room ${roomToJoin.code} randomly...`);
                joinRoom(roomToJoin.code); 
            } else {
                // Random Create Logic: If no rooms available, create a new public room
                displayError("No available rooms found. Creating a new public room (Random Create).");
                
                // Use the Public Chat Room option
                const publicOption = ROOM_OPTIONS.find(opt => opt.name === "Public Chat Room");
                const newCode = getRoomCode();
                
                // Simulate creation process
                if (createRoom(newCode, publicOption)) {
                    // Update UI to show the generated code for user reference
                    ui.currentCodeSpan.textContent = newCode;
                    ui.codeDisplay.classList.remove('hidden');
                }
            }
        }

        function leaveRoom() {
            if (!currentRoomCode || !userId) return;

            const room = localRooms[currentRoomCode];
            if (room) {
                // Remove participant
                delete room.participants[userId];

                // Add system message
                room.chatHistory.push({
                    senderId: 'SYSTEM',
                    name: 'System',
                    message: `${userName} has left the room.`,
                    timestamp: Date.now()
                });

                // If no participants remain, close the room (optional)
                if (Object.keys(room.participants).length === 0) {
                    delete localRooms[currentRoomCode];
                    console.log(`Room ${currentRoomCode} closed.`);
                }
            }

            // Cleanup
            currentRoomCode = null;
            showScreen('landing-screen');
            ui.userNameInput.value = userName; // Keep the name in the input
        }

        // --- UI Rendering Functions ---

        function updateRoomUI(room) {
            ui.roomHeaderOption.textContent = room.optionType;

            const participants = room.participants || {};
            const participantCount = Object.keys(participants).length;
            
            ui.pCount.textContent = participantCount;
            ui.pCountSidebar.textContent = participantCount;
            
            renderParticipants(participants);
            renderChat(room.chatHistory || []);
        }

        function renderParticipants(participants) {
            ui.participantList.innerHTML = '';
            // Sort by host status and then join time
            Object.values(participants).sort((a, b) => b.isHost - a.isHost || a.joinedAt - b.joinedAt).forEach(p => {
                const li = document.createElement('li');
                const isHost = p.isHost ? ' (Host)' : '';
                const isMe = p.name === userName ? ' (You)' : '';
                li.className = 'text-gray-700';
                li.innerHTML = `<span class="${p.isHost ? 'font-bold text-indigo-700' : ''}">${p.name}</span>${isHost}${isMe}`;
                ui.participantList.appendChild(li);
            });
        }

        function renderChat(messages) {
            ui.chatArea.innerHTML = '';
            messages.forEach(msg => {
                const isSystem = msg.senderId === 'SYSTEM';
                const isMe = msg.senderId === userId;
                const alignment = isMe ? 'self-end' : 'self-start';
                const bgColor = isMe ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-800';
                const nameDisplay = isMe ? 'You' : msg.name;
                const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const msgElement = document.createElement('div');
                msgElement.className = `max-w-[80%] p-2 rounded-lg ${alignment} ${isSystem ? 'text-center text-gray-500 italic text-xs w-full' : bgColor}`;

                if (isSystem) {
                    msgElement.textContent = msg.message;
                } else {
                    msgElement.innerHTML = `
                        <div class="text-xs font-semibold ${isMe ? 'text-indigo-200' : 'text-gray-600'}">${nameDisplay}</div>
                        <div>${msg.message}</div>
                        <div class="text-[10px] opacity-70 mt-1 ${isMe ? 'text-right' : 'text-left'}">${time}</div>
                    `;
                }
                ui.chatArea.appendChild(msgElement);
            });
            ui.chatArea.scrollTop = ui.chatArea.scrollHeight;
        }

        function sendChatMessage() {
            const message = ui.chatInput.value.trim();
            if (!message || !currentRoomCode) return;

            const room = localRooms[currentRoomCode];
            if (!room) return;

            const newMessage = {
                senderId: userId,
                name: userName,
                message: message,
                timestamp: Date.now()
            };

            // Add message to Local data
            room.chatHistory.push(newMessage);
            
            // Immediately update UI
            updateRoomUI(room);
            
            ui.chatInput.value = '';
            ui.chatInput.focus();
        }

        // --- Event Listeners ---

        document.getElementById('generate-code-btn').addEventListener('click', () => {
            if (!validateUserAndCode()) return;

            const newCode = getRoomCode();
            ui.currentCodeSpan.textContent = newCode;
            ui.codeDisplay.classList.remove('hidden');
            openOptions('create', newCode);
        });

        document.getElementById('enter-code-btn').addEventListener('click', () => {
            const code = ui.targetCodeInput.value.trim().toUpperCase();
            if (!validateUserAndCode(true)) return;
            
            // Check if the room exists before joining
            if (localRooms[code]) {
                joinRoom(code);
            } else {
                displayError("The entered room code does not exist.");
            }
        });

        document.getElementById('random-join-btn').addEventListener('click', randomJoinRoom);

        document.getElementById('cancel-options-btn').addEventListener('click', () => {
            showScreen('landing-screen');
        });

        ui.confirmOptionsBtn.addEventListener('click', () => {
            if (!selectedOption) {
                displayError("Please choose an option.");
                return;
            }

            if (joinType === 'create') {
                createRoom(currentRoomCode, selectedOption);
            } 
        });

        ui.sendChatBtn.addEventListener('click', sendChatMessage);
        ui.chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        ui.copyCodeBtn.addEventListener('click', () => {
            if (currentRoomCode) {
                const tempInput = document.createElement('input');
                tempInput.value = currentRoomCode;
                document.body.appendChild(tempInput);
                tempInput.select();
                // Use execCommand for copying to clipboard
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                ui.copyCodeBtn.textContent = 'Copied!';
                setTimeout(() => ui.copyCodeBtn.textContent = 'Copy Room Code', 2000);
            }
        });

        ui.leaveRoomBtn.addEventListener('click', leaveRoom);

        // Enable/disable buttons based on name input
        ui.userNameInput.addEventListener('input', () => {
            const name = ui.userNameInput.value.trim();
            const code = ui.targetCodeInput.value.trim();
            const isDisabled = name.length === 0;

            ui.generateCodeBtn.disabled = isDisabled;
            ui.randomJoinBtn.disabled = isDisabled;
            ui.enterCodeBtn.disabled = isDisabled || code.length < 6;
        });

        // Enable/disable 'Join Room' button based on code input
        ui.targetCodeInput.addEventListener('input', () => {
            const name = ui.userNameInput.value.trim();
            const code = ui.targetCodeInput.value.trim();

            ui.enterCodeBtn.disabled = name.length === 0 || code.length < 6;
        });


        // Initialize the App
        initializeApp();
    </script>
</body>
</html>
