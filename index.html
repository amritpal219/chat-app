<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Mixer | Real-Time Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-primary { @apply bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-700 transition duration-150 shadow-md disabled:opacity-50 disabled:cursor-not-allowed; }
        .btn-secondary { @apply bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-xl hover:bg-gray-300 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed; }
        .option-card { @apply p-4 border border-gray-200 rounded-lg cursor-pointer transition duration-200 hover:shadow-lg hover:border-indigo-500; }
        .selected-option { @apply border-indigo-600 ring-2 ring-indigo-300 bg-indigo-50; }
        #chat-area { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div id="app-container" class="w-full max-w-2xl">

        <!-- Screen 1: Landing/Entry -->
        <div id="landing-screen" class="card p-8 text-center">
            <h1 class="text-3xl font-bold mb-6 text-gray-800">Room Mixer (Real-Time Chat)</h1>
            <p class="text-sm text-gray-500 mb-6">Apna naam bharo â†’ Option chuno â†’ Room banao/Join karo. (Firebase)</p>

            <div class="space-y-4">
                <input type="text" id="user-name" placeholder="Apna naam (Enter your name)" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500" maxlength="20">

                <!-- Room Code Generation/Joining -->
                <div id="code-section" class="flex flex-col gap-3">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="generate-code-btn" class="btn-primary w-full sm:w-1/2" disabled>Code Banao & Create Karo</button>
                        <button id="random-join-btn" class="btn-secondary w-full sm:w-1/2" disabled>Random Join / Create Karo</button>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="target-code" placeholder="Code Bharo (Enter Code)" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 uppercase" maxlength="6">
                        <button id="enter-code-btn" class="btn-primary flex-shrink-0 px-4" disabled>Room Join Karo</button>
                    </div>
                </div>

                <!-- Code Display -->
                <div id="code-display" class="hidden bg-indigo-50 p-4 rounded-xl text-indigo-700 font-mono text-lg transition duration-300">
                    Tuhada Room Code: <span id="current-code" class="font-bold"></span>
                </div>
            </div>
            
            <p id="loading-message" class="text-indigo-500 mt-4 text-sm font-medium flex items-center justify-center">
                Firebase Init ho reha hai...
            </p>
            <p id="error-message" class="text-red-500 mt-4 text-sm font-medium"></p>
        </div>

        <!-- Screen 2: Options Modal -->
        <div id="options-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="card p-8 w-full max-w-lg">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">2 options chuno</h2>

                <div id="option-cards" class="grid grid-cols-2 gap-4 mb-6">
                    <!-- Options rendered by JS -->
                </div>

                <div class="flex justify-end gap-4">
                    <button id="cancel-options-btn" class="btn-secondary">Cancel Karo</button>
                    <button id="confirm-options-btn" class="btn-primary" disabled>Confirm & Aggge Vaddho</button>
                </div>
            </div>
        </div>

        <!-- Screen 3: Room Screen -->
        <div id="room-screen" class="hidden card p-6">
            <div class="flex justify-between items-center border-b pb-4 mb-4">
                <h2 class="text-xl font-bold text-indigo-600">Room: <span id="room-header-code"></span></h2>
                <div class="flex items-center space-x-2 text-sm text-gray-500">
                    <span id="room-header-option" class="font-medium px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full"></span>
                    <span id="room-participant-count" class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        <span id="p-count">1</span>
                    </span>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- Chat Area -->
                <div class="lg:col-span-2">
                    <div id="chat-area" class="bg-gray-50 p-3 rounded-xl border mb-3 min-h-[250px] flex flex-col justify-end space-y-2">
                        <!-- Messages displayed here -->
                        <div class="text-center text-sm text-gray-400 p-2">Tusi room <span id="chat-joined-code" class="font-mono font-semibold"></span> join kar liya hai â€” Chat shuru karo!</div>
                    </div>

                    <div class="flex space-x-2">
                        <input type="text" id="chat-input" placeholder="Apna message type karo..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500" autofocus>
                        <button id="send-chat-btn" class="btn-primary flex-shrink-0 px-4">Bhejo</button>
                    </div>

                    <p class="text-xs text-gray-500 mt-2">
                        Eh app real-time Firebase Firestore database use karda hai.
                    </p>
                </div>

                <!-- Participants & Controls Sidebar -->
                <div class="lg:col-span-1 space-y-4">
                    <!-- Participant List -->
                    <div class="bg-white p-3 rounded-xl border">
                        <h3 class="font-semibold mb-2">Participants (<span id="p-count-sidebar">1</span>)</h3>
                        <ul id="participant-list" class="space-y-1 text-sm">
                            <!-- Participants displayed here -->
                        </ul>
                    </div>

                    <!-- Room Controls -->
                    <div class="space-y-2">
                        <button id="copy-code-btn" class="btn-secondary w-full">Room Code Copy Karo</button>
                        <button id="leave-room-btn" class="bg-red-500 text-white font-semibold py-3 px-6 rounded-xl hover:bg-red-600 transition duration-150 w-full">Room Chhadd Do</button>
                    </div>
                    <div class="text-xs text-gray-400 break-all p-2 bg-gray-50 rounded-lg">
                        Tuhada User ID: <span id="user-id-display"></span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase and JavaScript Logic (Real-Time Network) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, arrayUnion, arrayRemove, where, getDocs, runTransaction, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase Instances
        let app, db, auth;
        let userId = null;
        let authReady = false;

        // Global State Variables
        let userName = '';
        let currentRoomCode = null;
        let selectedOption = null;
        let joinType = 'create';
        let unsubscribeRoom = null; // Listener for real-time room updates

        // UI Elements
        const ui = {
            landingScreen: document.getElementById('landing-screen'),
            optionsModal: document.getElementById('options-modal'),
            roomScreen: document.getElementById('room-screen'),
            userNameInput: document.getElementById('user-name'),
            targetCodeInput: document.getElementById('target-code'),
            currentCodeSpan: document.getElementById('current-code'),
            codeDisplay: document.getElementById('code-display'),
            errorMsg: document.getElementById('error-message'),
            loadingMsg: document.getElementById('loading-message'), 
            optionsCards: document.getElementById('option-cards'),
            confirmOptionsBtn: document.getElementById('confirm-options-btn'),
            roomHeaderCode: document.getElementById('room-header-code'),
            roomHeaderOption: document.getElementById('room-header-option'),
            pCount: document.getElementById('p-count'),
            pCountSidebar: document.getElementById('p-count-sidebar'),
            chatJoinedCode: document.getElementById('chat-joined-code'),
            chatArea: document.getElementById('chat-area'),
            chatInput: document.getElementById('chat-input'),
            sendChatBtn: document.getElementById('send-chat-btn'),
            participantList: document.getElementById('participant-list'),
            copyCodeBtn: document.getElementById('copy-code-btn'),
            leaveRoomBtn: document.getElementById('leave-room-btn'),
            generateCodeBtn: document.getElementById('generate-code-btn'),
            enterCodeBtn: document.getElementById('enter-code-btn'),
            randomJoinBtn: document.getElementById('random-join-btn'),
            userIdDisplay: document.getElementById('user-id-display'),
        };

        // Room Options
        const ROOM_OPTIONS = [
            { id: 1, name: "Public Chat Room", icon: "ðŸ’¬", description: "Open chat room, koi vi join kar sakda hai." },
            { id: 2, name: "Private Chat Room", icon: "ðŸ”’", description: "Secret room, sirf host de invite naal (Simple room)." },
        ];

        // Firestore Paths (Mandatory Structure)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const getRoomPath = (code) => `artifacts/${appId}/public/data/rooms/${code}`;
        const roomCollectionPath = `artifacts/${appId}/public/data/rooms`;


        // --- Core Helpers ---

        function showScreen(screenId) {
            ui.landingScreen.classList.add('hidden');
            ui.optionsModal.classList.add('hidden');
            ui.roomScreen.classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');

            if (screenId !== 'options-modal') {
                ui.optionsModal.classList.remove('fixed', 'flex');
            } else {
                ui.optionsModal.classList.add('fixed', 'flex');
            }
        }

        function displayError(message) {
            ui.errorMsg.textContent = message;
            setTimeout(() => ui.errorMsg.textContent = '', 5000);
        }

        // Generate a 6-character random code
        function getRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function validateUserAndCode(isCodeRequired = false) {
            userName = ui.userNameInput.value.trim();
            if (!userName || !authReady) {
                displayError("Pehle apna naam bharo te Firebase di wait karo.");
                return false;
            }
            if (isCodeRequired && ui.targetCodeInput.value.trim().length !== 6) {
                displayError("Kripa karke 6-character da room code bharo.");
                return false;
            }
            return true;
        }

        function enableAppButtons() {
            ui.loadingMsg.classList.add('hidden');
            const isDisabled = ui.userNameInput.value.trim().length === 0;

            ui.generateCodeBtn.disabled = isDisabled;
            ui.randomJoinBtn.disabled = isDisabled;
            ui.userNameInput.disabled = false;
            ui.targetCodeInput.disabled = false;
            
            const code = ui.targetCodeInput.value.trim();
            ui.enterCodeBtn.disabled = isDisabled || code.length < 6;
        }

        // --- Firebase Initialization and Auth ---

        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // For debugging in console

                // Handle Auth
                const authPromise = new Promise(resolve => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            authReady = true;
                            ui.userIdDisplay.textContent = userId;
                            resolve();
                        } else {
                            try {
                                if (typeof __initial_auth_token !== 'undefined') {
                                    await signInWithCustomToken(auth, __initial_auth_token);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (e) {
                                console.error("Auth failed:", e);
                                authReady = true; // Still mark as ready to show error
                                resolve();
                            }
                        }
                    });
                });

                await authPromise;
                
                // Final Check and Enable
                if (authReady && userId) {
                    enableAppButtons();
                    console.log("Firebase te Auth successful.");
                } else {
                    displayError("Firebase Auth nahi ho paya. Dobara koshish karo.");
                }

            } catch (e) {
                console.error("Firebase init error:", e);
                displayError("App shuru karan vich galti: " + e.message);
            }
        }

        // --- Options UI/Logic ---

        function renderOptions() {
            ui.optionsCards.innerHTML = ROOM_OPTIONS.map(opt => `
                <div class="option-card flex flex-col items-center text-center p-4" data-id="${opt.id}" data-name="${opt.name}">
                    <span class="text-3xl mb-2">${opt.icon}</span>
                    <h4 class="font-semibold text-gray-800">${opt.name}</h4>
                    <p class="text-xs text-gray-500 mt-1">${opt.description}</p>
                </div>
            `).join('');

            document.querySelectorAll('.option-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected-option'));
                    card.classList.add('selected-option');
                    selectedOption = ROOM_OPTIONS.find(o => o.id === parseInt(card.dataset.id));
                    ui.confirmOptionsBtn.disabled = false;
                });
            });
        }

        function openOptions(type, code = null) {
            joinType = type;
            currentRoomCode = code;
            ui.confirmOptionsBtn.disabled = true;
            selectedOption = null;
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected-option'));

            const actionText = (type === 'create') ? 'Banao' : 'Join Karo'; 
            ui.confirmOptionsBtn.textContent = `Confirm & ${actionText}`;

            showScreen('options-modal');
        }

        // --- Room Management (Firestore) ---

        async function createRoom(code, option) {
            if (!authReady) return displayError("Auth ready nahi hai.");

            const roomRef = doc(db, getRoomPath(code));
            
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);

                    if (roomDoc.exists()) {
                        throw new Error("Eh code pehle hi use ho chukka hai.");
                    }

                    const newRoomData = {
                        code: code,
                        optionType: option.name,
                        hostId: userId,
                        createdAt: Date.now(),
                        participants: {
                            [userId]: { name: userName, joinedAt: Date.now(), isHost: true }
                        },
                        chatHistory: [{
                            senderId: 'SYSTEM',
                            name: 'System',
                            message: `${userName} ne room banaya.`,
                            timestamp: Date.now()
                        }],
                        status: 'active'
                    };
                    transaction.set(roomRef, newRoomData);
                });

                console.log("Room ban gaya (Firestore):", code);
                joinRoom(code); // Transaction successful, now join/start listening
                return true;

            } catch (e) {
                console.error("Room create error:", e.message);
                displayError("Room bana nahi: " + e.message);
                return false;
            }
        }

        async function joinRoom(code) {
            if (!authReady) return displayError("Auth ready nahi hai.");
            if (unsubscribeRoom) unsubscribeRoom(); // Stop any previous listener

            const roomRef = doc(db, getRoomPath(code));
            currentRoomCode = code;
            ui.roomHeaderCode.textContent = code;
            ui.chatJoinedCode.textContent = code;
            showScreen('room-screen');
            
            // 1. Transaction to add participant
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);

                    if (!roomDoc.exists() || roomDoc.data().status !== 'active') {
                        throw new Error("Room code nahi labheya ya room band hai.");
                    }

                    const roomData = roomDoc.data();
                    const participants = roomData.participants || {};

                    if (participants[userId]) {
                        // User already joined, just update name if needed
                        participants[userId].name = userName;
                    } else {
                        // Check participant limit (max 8 for simulation)
                        if (Object.keys(participants).length >= 8) {
                            throw new Error("Room poora bhar chukka hai (max 8).");
                        }
                        
                        // Add new participant
                        participants[userId] = {
                            name: userName,
                            joinedAt: Date.now(),
                            isHost: (roomData.hostId === userId)
                        };

                        // Add system message
                        const systemMessage = {
                            senderId: 'SYSTEM',
                            name: 'System',
                            message: `${userName} ne room join kar leya hai.`,
                            timestamp: Date.now()
                        };
                        
                        transaction.update(roomRef, {
                            participants: participants,
                            chatHistory: arrayUnion(systemMessage)
                        });
                    }
                });
            } catch (e) {
                console.error("Join room transaction failed:", e.message);
                displayError("Room join nahi ho paya: " + e.message);
                currentRoomCode = null;
                showScreen('landing-screen');
                return;
            }

            // 2. Set up Real-Time Listener
            unsubscribeRoom = onSnapshot(roomRef, (doc) => {
                if (doc.exists() && doc.data().status === 'active') {
                    updateRoomUI(doc.data());
                } else {
                    // Room deleted or closed by host
                    displayError("Room band ho gaya hai.");
                    leaveRoom(false);
                }
            }, (error) => {
                console.error("Real-time listener error:", error);
                displayError("Real-time connection tut gaya: " + error.message);
                leaveRoom(false);
            });
        }

        async function randomJoinRoom() {
            if (!validateUserAndCode()) return;

            const roomsRef = collection(db, roomCollectionPath);
            // Query for active rooms with less than 8 participants
            const q = query(roomsRef, where('status', '==', 'active'));

            try {
                const querySnapshot = await getDocs(q);
                let availableRooms = [];
                querySnapshot.forEach(doc => {
                    const room = doc.data();
                    if (Object.keys(room.participants || {}).length < 8) {
                        availableRooms.push(room);
                    }
                });

                if (availableRooms.length > 0) {
                    // Random Join: Pick the first available room (or random)
                    const roomToJoin = availableRooms[0];
                    displayError(`Room ${roomToJoin.code} vich randomly join kar rahe haan...`);
                    joinRoom(roomToJoin.code);
                } else {
                    // Random Create Logic: If no rooms available, create a new public room
                    displayError("Koi room available nahi. Nawa Public room bana rahe haan...");
                    
                    const publicOption = ROOM_OPTIONS.find(opt => opt.name === "Public Chat Room");
                    const newCode = getRoomCode();
                    
                    if (await createRoom(newCode, publicOption)) {
                        ui.currentCodeSpan.textContent = newCode;
                        ui.codeDisplay.classList.remove('hidden');
                    }
                }
            } catch (e) {
                console.error("Random join error:", e);
                displayError("Random join karan vich galti ho gayi.");
            }
        }

        async function leaveRoom(navigate = true) {
            if (!currentRoomCode || !userId) return;

            if (unsubscribeRoom) {
                unsubscribeRoom();
                unsubscribeRoom = null;
            }

            const roomRef = doc(db, getRoomPath(currentRoomCode));
            const roomCodeToLeave = currentRoomCode;
            currentRoomCode = null; // Clear state immediately

            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);

                    if (roomDoc.exists()) {
                        const roomData = roomDoc.data();
                        const participants = roomData.participants || {};
                        
                        // Remove participant
                        if (participants[userId]) {
                            delete participants[userId];

                            // Add system message
                            const systemMessage = {
                                senderId: 'SYSTEM',
                                name: 'System',
                                message: `${userName} ne room chhadd ditta.`,
                                timestamp: Date.now()
                            };

                            // Check if room should be deleted
                            if (Object.keys(participants).length === 0) {
                                transaction.delete(roomRef);
                                console.log(`Room ${roomCodeToLeave} band kar ditta.`);
                            } else {
                                transaction.update(roomRef, {
                                    participants: participants,
                                    chatHistory: arrayUnion(systemMessage)
                                });
                            }
                        }
                    }
                });
            } catch (e) {
                console.error("Room chhaddan (leaving) vich galti:", e);
            }

            // Cleanup
            if (navigate) {
                showScreen('landing-screen');
                ui.userNameInput.value = userName;
            }
        }

        // --- UI Rendering Functions ---

        function updateRoomUI(room) {
            ui.roomHeaderOption.textContent = room.optionType;

            const participants = room.participants || {};
            const participantCount = Object.keys(participants).length;
            
            ui.pCount.textContent = participantCount;
            ui.pCountSidebar.textContent = participantCount;
            
            renderParticipants(participants);
            renderChat(room.chatHistory || []);
        }

        function renderParticipants(participants) {
            ui.participantList.innerHTML = '';
            // Sort by host status and then join time
            Object.values(participants).sort((a, b) => b.isHost - a.isHost || a.joinedAt - b.joinedAt).forEach(p => {
                const li = document.createElement('li');
                const isHost = p.isHost ? ' (Host)' : '';
                const isMe = p.name === userName ? ' (Tusi)' : '';
                li.className = 'text-gray-700';
                li.innerHTML = `<span class="${p.isHost ? 'font-bold text-indigo-700' : ''}">${p.name}</span>${isHost}${isMe}`;
                ui.participantList.appendChild(li);
            });
        }

        function renderChat(messages) {
            ui.chatArea.innerHTML = '';
            messages.forEach(msg => {
                const isSystem = msg.senderId === 'SYSTEM';
                const isMe = msg.senderId === userId;
                const alignment = isMe ? 'self-end' : 'self-start';
                const bgColor = isMe ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-800';
                const nameDisplay = isMe ? 'Tusi' : msg.name;
                const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const msgElement = document.createElement('div');
                msgElement.className = `max-w-[80%] p-2 rounded-lg ${alignment} ${isSystem ? 'text-center text-gray-500 italic text-xs w-full' : bgColor}`;

                if (isSystem) {
                    msgElement.textContent = msg.message;
                } else {
                    msgElement.innerHTML = `
                        <div class="text-xs font-semibold ${isMe ? 'text-indigo-200' : 'text-gray-600'}">${nameDisplay}</div>
                        <div>${msg.message}</div>
                        <div class="text-[10px] opacity-70 mt-1 ${isMe ? 'text-right' : 'text-left'}">${time}</div>
                    `;
                }
                ui.chatArea.appendChild(msgElement);
            });
            ui.chatArea.scrollTop = ui.chatArea.scrollHeight;
        }

        async function sendChatMessage() {
            const message = ui.chatInput.value.trim();
            if (!message || !currentRoomCode) return;

            const roomRef = doc(db, getRoomPath(currentRoomCode));

            const newMessage = {
                senderId: userId,
                name: userName,
                message: message,
                timestamp: Date.now()
            };

            ui.chatInput.value = ''; // Clear input immediately
            ui.chatInput.focus();

            try {
                // Use arrayUnion to safely append message to the array
                await updateDoc(roomRef, {
                    chatHistory: arrayUnion(newMessage)
                });
            } catch (e) {
                console.error("Message bhejan vich galti:", e);
                displayError("Message bhejan vich galti ho gayi.");
            }
        }

        // --- Event Listeners ---

        document.getElementById('generate-code-btn').addEventListener('click', () => {
            if (!validateUserAndCode()) return;

            const newCode = getRoomCode();
            ui.currentCodeSpan.textContent = newCode;
            ui.codeDisplay.classList.remove('hidden');
            openOptions('create', newCode);
        });

        document.getElementById('enter-code-btn').addEventListener('click', () => {
            const code = ui.targetCodeInput.value.trim().toUpperCase();
            if (!validateUserAndCode(true)) return;
            
            // Just attempt to join; the joinRoom function handles existence check
            joinRoom(code);
        });

        document.getElementById('random-join-btn').addEventListener('click', randomJoinRoom);

        document.getElementById('cancel-options-btn').addEventListener('click', () => {
            showScreen('landing-screen');
        });

        ui.confirmOptionsBtn.addEventListener('click', async () => {
            if (!selectedOption) {
                displayError("Kripa karke ek option chuno.");
                return;
            }

            if (joinType === 'create') {
                await createRoom(currentRoomCode, selectedOption);
            } 
            // Join path is simple: just call joinRoom with existing code
            // else if (joinType === 'join') { 
            //     await joinRoom(currentRoomCode);
            // } 
        });

        ui.sendChatBtn.addEventListener('click', sendChatMessage);
        ui.chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        ui.copyCodeBtn.addEventListener('click', () => {
            if (currentRoomCode) {
                const tempInput = document.createElement('input');
                tempInput.value = currentRoomCode;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                ui.copyCodeBtn.textContent = 'Copy Ho Gaya!';
                setTimeout(() => ui.copyCodeBtn.textContent = 'Room Code Copy Karo', 2000);
            }
        });

        ui.leaveRoomBtn.addEventListener('click', () => leaveRoom(true));

        // Enable/disable buttons based on name input
        ui.userNameInput.addEventListener('input', enableAppButtons);

        // Enable/disable 'Join Room' button based on code input
        ui.targetCodeInput.addEventListener('input', enableAppButtons);


        // Initialize the App
        initializeFirebase();
        renderOptions();
    </script>
</body>
</html>
