<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Mixer | Quick Join & Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-primary { @apply bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-700 transition duration-150 shadow-md disabled:opacity-50 disabled:cursor-not-allowed; }
        .btn-secondary { @apply bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-xl hover:bg-gray-300 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed; }
        .option-card { @apply p-4 border border-gray-200 rounded-lg cursor-pointer transition duration-200 hover:shadow-lg hover:border-indigo-500; }
        .selected-option { @apply border-indigo-600 ring-2 ring-indigo-300 bg-indigo-50; }
        #chat-area { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div id="app-container" class="w-full max-w-2xl">

        <!-- Screen 1: Landing/Entry -->
        <div id="landing-screen" class="card p-8 text-center">
            <h1 class="text-3xl font-bold mb-6 text-gray-800">Room Mixer</h1>
            <p class="text-sm text-gray-500 mb-6">Fill name â†’ choose option â†’ create/join room</p>

            <div class="space-y-4">
                <input type="text" id="user-name" placeholder="Enter your name" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500" maxlength="20">

                <!-- Room Code Generation/Joining -->
                <div id="code-section" class="flex flex-col sm:flex-row gap-4">
                    <button id="generate-code-btn" class="btn-primary w-full sm:w-1/2" disabled>Generate Code</button>
                    <div class="w-full sm:w-1/2 flex gap-2">
                        <input type="text" id="target-code" placeholder="Enter Code" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 uppercase" maxlength="6">
                        <button id="enter-code-btn" class="btn-primary flex-shrink-0 px-4" disabled>Enter</button>
                    </div>
                </div>

                <!-- Code Display -->
                <div id="code-display" class="hidden bg-indigo-50 p-4 rounded-xl text-indigo-700 font-mono text-lg transition duration-300">
                    Your Room Code: <span id="current-code" class="font-bold"></span>
                </div>
            </div>
            
            <p id="loading-message" class="text-indigo-500 mt-4 text-sm font-medium flex items-center justify-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Initializing App...
            </p>
            <p id="error-message" class="text-red-500 mt-4 text-sm font-medium"></p>
        </div>

        <!-- Screen 2: Options Modal -->
        <div id="options-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="card p-8 w-full max-w-lg">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">Choose one of these 4 options</h2>

                <div id="option-cards" class="grid grid-cols-2 gap-4 mb-6">
                    <!-- Options will be generated here by JS -->
                </div>

                <div class="flex justify-end gap-4">
                    <button id="cancel-options-btn" class="btn-secondary">Cancel</button>
                    <button id="confirm-options-btn" class="btn-primary" disabled>Confirm & Proceed</button>
                </div>
            </div>
        </div>

        <!-- Screen 3: Room Screen -->
        <div id="room-screen" class="hidden card p-6">
            <div class="flex justify-between items-center border-b pb-4 mb-4">
                <h2 class="text-xl font-bold text-indigo-600">Room: <span id="room-header-code"></span></h2>
                <div class="flex items-center space-x-2 text-sm text-gray-500">
                    <span id="room-header-option" class="font-medium px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full"></span>
                    <span id="room-participant-count" class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        <span id="p-count">1</span>
                    </span>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- Chat Area (2/3 width on desktop) -->
                <div class="lg:col-span-2">
                    <div id="chat-area" class="bg-gray-50 p-3 rounded-xl border mb-3 min-h-[250px] flex flex-col justify-end space-y-2">
                        <!-- Messages go here -->
                        <div class="text-center text-sm text-gray-400 p-2">You joined room <span id="chat-joined-code" class="font-mono font-semibold"></span> â€” say hi!</div>
                    </div>

                    <div class="flex space-x-2">
                        <input type="text" id="chat-input" placeholder="Type a message..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500" autofocus>
                        <button id="send-chat-btn" class="btn-primary flex-shrink-0 px-4">Send</button>
                    </div>

                    <p class="text-xs text-gray-500 mt-2">
                        Voice/Video is enabled by WebRTC, but requires a signaling server for full connection. Text chat uses Firestore.
                    </p>
                </div>

                <!-- Right Sidebar (1/3 width on desktop) -->
                <div class="lg:col-span-1 space-y-4">
                    <!-- Participant List -->
                    <div class="bg-white p-3 rounded-xl border">
                        <h3 class="font-semibold mb-2">Participants (<span id="p-count-sidebar">1</span>)</h3>
                        <ul id="participant-list" class="space-y-1 text-sm">
                            <!-- Participants go here -->
                        </ul>
                    </div>

                    <!-- Room Controls -->
                    <div class="space-y-2">
                        <button id="copy-code-btn" class="btn-secondary w-full">Copy Room Code</button>
                        <button id="leave-room-btn" class="bg-red-500 text-white font-semibold py-3 px-6 rounded-xl hover:bg-red-600 transition duration-150 w-full">Leave Room</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, arrayUnion, arrayRemove, runTransaction, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and App Configuration
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // FIX: Corrected variable name from __initialAuthToken to __initial_auth_token
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        let app, db, auth, userId, userName;
        let isAuthReady = false; 
        let currentRoomCode = null;
        let currentRoomRef = null;
        let selectedOption = null;
        let joinType = 'create';
        let unsubscribeRoom = null;

        // UI Elements
        const ui = {
            landingScreen: document.getElementById('landing-screen'),
            optionsModal: document.getElementById('options-modal'),
            roomScreen: document.getElementById('room-screen'),
            userNameInput: document.getElementById('user-name'),
            targetCodeInput: document.getElementById('target-code'),
            currentCodeSpan: document.getElementById('current-code'),
            codeDisplay: document.getElementById('code-display'),
            errorMsg: document.getElementById('error-message'),
            loadingMsg: document.getElementById('loading-message'), 
            optionsCards: document.getElementById('option-cards'),
            confirmOptionsBtn: document.getElementById('confirm-options-btn'),
            roomHeaderCode: document.getElementById('room-header-code'),
            roomHeaderOption: document.getElementById('room-header-option'),
            pCount: document.getElementById('p-count'),
            pCountSidebar: document.getElementById('p-count-sidebar'),
            chatJoinedCode: document.getElementById('chat-joined-code'),
            chatArea: document.getElementById('chat-area'),
            chatInput: document.getElementById('chat-input'),
            sendChatBtn: document.getElementById('send-chat-btn'),
            participantList: document.getElementById('participant-list'),
            copyCodeBtn: document.getElementById('copy-code-btn'),
            leaveRoomBtn: document.getElementById('leave-room-btn'),
            generateCodeBtn: document.getElementById('generate-code-btn'),
            enterCodeBtn: document.getElementById('enter-code-btn'),
        };

        const ROOM_OPTIONS = [
            { id: 1, name: "Public Chat", icon: "ðŸ’¬", description: "Open chat, anyone can join with the code." },
            { id: 2, name: "Private Room", icon: "ðŸ”’", description: "Host approval required to join (simulated)." },
            { id: 3, name: "Topic Room", icon: "ðŸ·ï¸", description: "Designed for a specific topic (e.g., music, homework)." },
            { id: 4, name: "Random Mixer", icon: "ðŸŽ²", description: "Ephemeral random matching (now only available by choice)." },
        ];

        // --- Core Helpers ---

        function showScreen(screenId) {
            ui.landingScreen.classList.add('hidden');
            ui.optionsModal.classList.add('hidden');
            ui.roomScreen.classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');

            if (screenId !== 'options-modal') {
                ui.optionsModal.classList.remove('fixed', 'flex');
            } else {
                ui.optionsModal.classList.add('fixed', 'flex');
            }
        }

        function displayError(message) {
            ui.errorMsg.textContent = message;
            setTimeout(() => ui.errorMsg.textContent = '', 5000);
        }

        function getRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function validateUserAndCode(isCodeRequired = false) {
            if (!isAuthReady) {
                displayError("App is still initializing. Please wait a moment.");
                return false;
            }
            userName = ui.userNameInput.value.trim();
            if (!userName) {
                displayError("Please enter your name.");
                return false;
            }
            if (isCodeRequired && !ui.targetCodeInput.value.trim()) {
                displayError("Please enter a room code.");
                return false;
            }
            return true;
        }

        function enableAppButtons() {
            ui.loadingMsg.classList.add('hidden');
            ui.generateCodeBtn.disabled = false;
            ui.enterCodeBtn.disabled = false;
            ui.userNameInput.disabled = false;
            ui.targetCodeInput.disabled = false;
            console.log("Application buttons enabled.");
        }

        // --- Firebase & Auth Setup ---

        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config not available. Using anonymous sign-in only.");
                app = initializeApp({});
            } else {
                app = initializeApp(firebaseConfig);
            }

            db = getFirestore(app);
            auth = getAuth(app);

            try {
                // Use the corrected initialAuthToken variable
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth); 
                }
            } catch (error) {
                console.error("Initial Authentication failed:", error);
                await signInAnonymously(auth); 
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true; 
                    console.log("Firebase Auth Ready. User ID:", userId);
                    renderOptions(); 
                    enableAppButtons();
                } else {
                    console.log("No user signed in.");
                    isAuthReady = false;
                    ui.loadingMsg.textContent = "Authentication failed. Try reloading.";
                }
            });
        }

        // --- Options UI/Logic ---

        function renderOptions() {
            ui.optionsCards.innerHTML = ROOM_OPTIONS.map(opt => `
                <div class="option-card flex flex-col items-center text-center p-4" data-id="${opt.id}" data-name="${opt.name}">
                    <span class="text-3xl mb-2">${opt.icon}</span>
                    <h4 class="font-semibold text-gray-800">${opt.name}</h4>
                    <p class="text-xs text-gray-500 mt-1">${opt.description}</p>
                </div>
            `).join('');

            document.querySelectorAll('.option-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected-option'));
                    card.classList.add('selected-option');
                    selectedOption = ROOM_OPTIONS.find(o => o.id === parseInt(card.dataset.id));
                    ui.confirmOptionsBtn.disabled = false;
                });
            });
        }

        function openOptions(type, code = null) {
            joinType = type;
            currentRoomCode = code;
            ui.confirmOptionsBtn.disabled = true;
            selectedOption = null;
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected-option'));

            const actionText = (type === 'create') ? 'Create' : 'Join'; 
            ui.confirmOptionsBtn.textContent = `Confirm & ${actionText}`;

            showScreen('options-modal');
        }

        // --- Room Management (Firestore) ---

        async function createRoom(code, option) {
            if (!userId) {
                displayError("Authentication failed. Cannot create room.");
                return false;
            }
            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, code);

            const newRoomData = {
                code: code,
                optionType: option.name,
                hostId: userId,
                createdAt: Date.now(),
                participants: {
                    [userId]: { name: userName, joinedAt: Date.now(), isHost: true }
                },
                chatHistory: [],
                discoverable: false,
                status: 'active'
            };

            try {
                await setDoc(roomRef, newRoomData);
                console.log("Room created successfully:", code);
                joinRoom(code);
                return true;
            } catch (e) {
                console.error("Error creating room:", e);
                displayError("Failed to create room. Try a different code.");
                return false;
            }
        }

        async function joinRoom(code) {
            if (!userId) {
                displayError("Authentication failed. Cannot join room.");
                return;
            }

            currentRoomCode = code;
            currentRoomRef = doc(db, `artifacts/${appId}/public/data/rooms`, code);
            ui.chatJoinedCode.textContent = code;

            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(currentRoomRef);
                    if (!roomDoc.exists()) {
                        throw "Room code not found or room has been closed.";
                    }

                    const room = roomDoc.data();
                    const participants = room.participants || {};

                    if (participants[userId]) {
                        console.log("User already in room. Proceeding to room screen.");
                        return;
                    }

                    if (Object.keys(participants).length >= 8) {
                        throw "Room is full (max 8 participants).";
                    }

                    participants[userId] = {
                        name: userName,
                        joinedAt: Date.now(),
                        isHost: (room.hostId === userId)
                    };

                    transaction.update(currentRoomRef, { participants: participants });
                    transaction.update(currentRoomRef, {
                        chatHistory: arrayUnion({
                            senderId: 'SYSTEM',
                            name: 'System',
                            message: `${userName} has joined the room.`,
                            timestamp: Date.now()
                        })
                    });
                });

                listenToRoom(currentRoomRef);

                showScreen('room-screen');
                ui.roomHeaderCode.textContent = currentRoomCode;

            } catch (error) {
                console.error("Error joining room:", error);
                displayError(typeof error === 'string' ? error : "Failed to join room. Check the code.");
                currentRoomCode = null;
                currentRoomRef = null;
                showScreen('landing-screen');
            }
        }

        async function leaveRoom() {
            if (!currentRoomCode || !userId) return;

            // Remove participant
            const participantUpdate = {};
            participantUpdate[`participants.${userId}`] = deleteField(); 

            try {
                await updateDoc(currentRoomRef, participantUpdate);
                await updateDoc(currentRoomRef, {
                    chatHistory: arrayUnion({
                        senderId: 'SYSTEM',
                        name: 'System',
                        message: `${userName} has left the room.`,
                        timestamp: Date.now()
                    })
                });
                console.log(`Left room ${currentRoomCode}`);
            } catch (e) {
                console.error("Error leaving room:", e);
            }

            // Cleanup
            if (unsubscribeRoom) {
                unsubscribeRoom();
            }
            currentRoomCode = null;
            currentRoomRef = null;
            showScreen('landing-screen');
            ui.userNameInput.value = userName;
        }

        function listenToRoom(roomRef) {
            if (unsubscribeRoom) {
                unsubscribeRoom();
            }

            unsubscribeRoom = onSnapshot(roomRef, (docSnapshot) => {
                if (!docSnapshot.exists()) {
                    displayError("Room closed by host.");
                    leaveRoom();
                    return;
                }

                const room = docSnapshot.data();
                if (!room) return;

                ui.roomHeaderOption.textContent = room.optionType;

                const participants = room.participants || {};
                const participantCount = Object.keys(participants).length;
                ui.pCount.textContent = participantCount;
                ui.pCountSidebar.textContent = participantCount;
                renderParticipants(participants);

                if (!participants[userId]) {
                    if (currentRoomCode) {
                        displayError("You have been removed from the room.");
                        leaveRoom();
                    }
                    return;
                }

                renderChat(room.chatHistory || []);
            }, (error) => {
                console.error("Room snapshot error:", error);
                displayError("Disconnected from room. Please try joining again.");
                leaveRoom();
            });
        }

        function renderParticipants(participants) {
            ui.participantList.innerHTML = '';
            // Sort by host status (true first) then by join time
            Object.values(participants).sort((a, b) => b.isHost - a.isHost || a.joinedAt - b.joinedAt).forEach(p => {
                const li = document.createElement('li');
                const isHost = p.isHost ? ' (Host)' : '';
                const isMe = p.name === userName ? ' (You)' : '';
                li.className = 'text-gray-700';
                li.innerHTML = `<span class="${p.isHost ? 'font-bold text-indigo-700' : ''}">${p.name}</span>${isHost}${isMe}`;
                ui.participantList.appendChild(li);
            });
        }

        function renderChat(messages) {
            ui.chatArea.innerHTML = '';
            messages.forEach(msg => {
                const isSystem = msg.senderId === 'SYSTEM';
                const isMe = msg.senderId === userId;
                const alignment = isMe ? 'self-end' : 'self-start';
                const bgColor = isMe ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-800';
                const nameDisplay = isMe ? 'You' : msg.name;
                const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const msgElement = document.createElement('div');
                msgElement.className = `max-w-[80%] p-2 rounded-lg ${alignment} ${isSystem ? 'text-center text-gray-500 italic text-xs w-full' : bgColor}`;

                if (isSystem) {
                    msgElement.textContent = msg.message;
                } else {
                    msgElement.innerHTML = `
                        <div class="text-xs font-semibold ${isMe ? 'text-indigo-200' : 'text-gray-600'}">${nameDisplay}</div>
                        <div>${msg.message}</div>
                        <div class="text-[10px] opacity-70 mt-1 ${isMe ? 'text-right' : 'text-left'}">${time}</div>
                    `;
                }
                ui.chatArea.appendChild(msgElement);
            });
            ui.chatArea.scrollTop = ui.chatArea.scrollHeight;
        }

        async function sendChatMessage() {
            const message = ui.chatInput.value.trim();
            if (!message || !currentRoomRef) return;

            const newMessage = {
                senderId: userId,
                name: userName,
                message: message,
                timestamp: Date.now()
            };

            try {
                await updateDoc(currentRoomRef, {
                    chatHistory: arrayUnion(newMessage)
                });
                ui.chatInput.value = '';
                ui.chatInput.focus();
            } catch (e) {
                console.error("Error sending message:", e);
                displayError("Could not send message.");
            }
        }

        // --- WebRTC Placeholder Functions ---

        const webrtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        function startWebRTC() {
            try {
                const pc = new RTCPeerConnection(webrtcConfig);
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log("WebRTC Candidate generated (needs signaling):", event.candidate);
                    }
                };
                pc.ontrack = (event) => {
                    console.log("Remote track received (needs signaling):", event.streams[0]);
                };
                console.log("WebRTC PeerConnection initialized. A signaling server is required for connection establishment.");
            } catch (e) {
                console.error("WebRTC initialization failed:", e);
            }
        }

        // --- Event Listeners ---

        document.getElementById('generate-code-btn').addEventListener('click', () => {
            if (!validateUserAndCode()) return;

            const newCode = getRoomCode();
            ui.currentCodeSpan.textContent = newCode;
            ui.codeDisplay.classList.remove('hidden');
            openOptions('create', newCode);
        });

        document.getElementById('enter-code-btn').addEventListener('click', () => {
            const code = ui.targetCodeInput.value.trim().toUpperCase();
            if (!validateUserAndCode(true)) return;
            joinRoom(code);
        });

        document.getElementById('cancel-options-btn').addEventListener('click', () => {
            showScreen('landing-screen');
        });

        ui.confirmOptionsBtn.addEventListener('click', async () => {
            if (!selectedOption) {
                displayError("Please select an option.");
                return;
            }

            if (joinType === 'create') {
                await createRoom(currentRoomCode, selectedOption);
            } 
        });

        ui.sendChatBtn.addEventListener('click', sendChatMessage);
        ui.chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        ui.copyCodeBtn.addEventListener('click', () => {
            if (currentRoomCode) {
                const tempInput = document.createElement('input');
                tempInput.value = currentRoomCode;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                ui.copyCodeBtn.textContent = 'Copied!';
                setTimeout(() => ui.copyCodeBtn.textContent = 'Copy Room Code', 2000);
            }
        });

        ui.leaveRoomBtn.addEventListener('click', leaveRoom);

        // Initialize App
        initializeFirebase();
        startWebRTC();
    </script>
</body>
</html>
